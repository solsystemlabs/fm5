# Story 0.2: Docker Development Environment Setup

## Status

Approved

## Story

**As a** developer,
**I want** the complete Docker development environment from the architecture specification,
**so that** PostgreSQL, Redis, and MinIO services are available for local development.

## Acceptance Criteria

1. Docker Compose configuration creates PostgreSQL 18 Beta container with extensions
2. Redis 7 Alpine container configured for session/cache storage during development
3. MinIO container configured for local Cloudflare R2 simulation
4. Database initialization script creates proper extensions (uuid-ossp, pg_stat_statements)
5. All services accessible on specified ports with health checks

## Tasks / Subtasks

- [ ] Create Docker Compose configuration file (AC: 1, 2, 3)
  - [ ] Set up PostgreSQL 18 Beta container with proper extensions
  - [ ] Configure Redis 7 Alpine container with persistence
  - [ ] Set up MinIO container for local S3 simulation
  - [ ] Configure proper networking between services
- [ ] Create database initialization script (AC: 4)
  - [ ] Install uuid-ossp extension for UUID generation
  - [ ] Install pg_stat_statements for query performance monitoring
  - [ ] Set up printmgmt_dev database with proper user permissions
  - [ ] Configure database initialization sequence
- [ ] Configure environment variables and ports (AC: 5)
  - [ ] Create .env.example template with all required configurations
  - [ ] Set up PostgreSQL on localhost:5432
  - [ ] Set up Redis on localhost:6379 with append-only persistence
  - [ ] Set up MinIO on localhost:9000/9001 with development credentials
- [ ] Implement health checks for all services (AC: 5)
  - [ ] PostgreSQL health check using pg_isready
  - [ ] Redis health check using redis-cli ping
  - [ ] MinIO health check using curl health endpoint
  - [ ] Configure proper timeout and retry settings
- [ ] Verify service integration and startup
  - [ ] Test docker-compose up starts all services reliably
  - [ ] Verify service connectivity between containers
  - [ ] Test volume persistence and data retention
  - [ ] Document startup procedure and troubleshooting

## Dev Notes

### Previous Story Insights

Story 0.1 completed successfully with Tanstack Start project scaffolding, TypeScript configuration, and proper folder structure established. The development environment foundation is ready for Docker service integration.

### Architecture Context

[Source: full-stack-architecture.md#tech-stack-decisions]

**Required Docker Services:**

- **PostgreSQL 18 Beta**: Latest PostgreSQL with enhanced JSONB capabilities for metadata storage
- **Redis 7 Alpine**: Session/cache storage for authentication and state management
- **MinIO**: Local S3-compatible storage for Cloudflare R2 development simulation

**Service Configuration Requirements:**

[Source: full-stack-architecture.md#docker-configuration]

```yaml
# docker-compose.dev.yml structure from architecture
services:
  postgres:
    image: postgres:18-beta
    environment:
      POSTGRES_DB: printmgmt_dev
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: devpass123
    ports:
      - '5432:5432'

  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'

  minio:
    image: minio/minio
    ports:
      - '9000:9000'
      - '9001:9001'
```

### Database Extensions Required

[Source: full-stack-architecture.md#postgresql-configuration]

**Critical Extensions for 3D Printing Platform:**

- **uuid-ossp**: UUID generation for all entity primary keys
- **pg_stat_statements**: Query performance monitoring for optimization
- **Additional extensions**: May be required in future stories (full-text search, etc.)

### Environment Variables Structure

[Source: core-config.yaml and architecture specifications]

**Development Environment (.env.example):**

```bash
# Database Configuration
DATABASE_URL=postgresql://dev:devpass123@localhost:5432/printmgmt_dev
POSTGRES_DB=printmgmt_dev
POSTGRES_USER=dev
POSTGRES_PASSWORD=devpass123

# Redis Configuration
REDIS_URL=redis://localhost:6379

# MinIO Configuration (Local R2 simulation)
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET=printmgmt-dev
MINIO_USE_SSL=false

# Application
NODE_ENV=development
APP_URL=http://localhost:3000
```

### File Locations

**New files to be created:**

- `/docker-compose.dev.yml` - Main Docker Compose configuration
- `/scripts/init-db.sql` - Database initialization script with extensions
- `/.env.example` - Environment variables template
- `/scripts/setup-dev-env.sh` - Optional setup automation script
- `/README.md` - Update with Docker setup instructions

**Docker Volume Strategy:**

- PostgreSQL data: Persistent named volume for database retention
- Redis data: Optional persistence for session continuity
- MinIO data: Persistent volume for file storage simulation

### Service Integration

**Network Configuration:**

- All services on default Docker network for inter-service communication
- External port mapping for local development access
- Service dependencies properly configured with health checks

**Startup Sequence:**

1. PostgreSQL starts first with health check
2. Redis starts with basic ping health check
3. MinIO starts with HTTP health endpoint check
4. Database initialization runs after PostgreSQL is healthy

### Health Check Strategy

[Source: full-stack-architecture.md#development-environment]

**PostgreSQL Health Check:**

```yaml
healthcheck:
  test: ['CMD-SHELL', 'pg_isready -U dev']
  interval: 10s
  timeout: 5s
  retries: 5
```

**Redis Health Check:**

```yaml
healthcheck:
  test: ['CMD', 'redis-cli', 'ping']
  interval: 10s
  timeout: 5s
  retries: 5
```

**MinIO Health Check:**

```yaml
healthcheck:
  test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
  interval: 30s
  timeout: 20s
  retries: 3
```

### Testing

Testing requirements for this foundational story:

- **Service Startup Testing**: Verify all services start without errors
- **Connectivity Testing**: Confirm inter-service communication works
- **Port Accessibility**: Validate external port access from host machine
- **Data Persistence**: Test volume mounting and data retention across restarts
- **Environment Loading**: Verify environment variables are properly loaded

### Technical Constraints

[Source: core-config.yaml and architecture specifications]

- **PostgreSQL Version**: Must be 18 Beta for latest JSONB enhancements
- **Redis Persistence**: Append-only file (AOF) for development session continuity
- **MinIO Compatibility**: Must be S3-compatible for seamless R2 migration
- **Port Requirements**: Standard ports (5432, 6379, 9000, 9001) for development consistency
- **Volume Management**: Named volumes for data persistence across container rebuilds

## Change Log

| Date       | Version | Description                                     | Author           |
| ---------- | ------- | ----------------------------------------------- | ---------------- |
| 2025-09-21 | 1.0     | Initial story creation from Epic 0 requirements | Scrum Master Bob |
| 2025-09-21 | 1.1     | Story validated and approved for implementation | Product Owner Sarah |

## QA Results

### Review Date: 2025-09-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

This is a well-structured foundational infrastructure story with comprehensive technical context and clear requirements. The story demonstrates excellent preparation with detailed Dev Notes that provide essential architecture context, specific configuration requirements, and testing considerations. The acceptance criteria are concrete and measurable, making this story highly implementable.

**Strengths:**
- Complete Docker service specifications with exact versions (PostgreSQL 18 Beta, Redis 7 Alpine, MinIO)
- Detailed environment variable structure and file location guidance
- Comprehensive health check configurations for all services
- Clear testing requirements covering service startup, connectivity, and persistence
- Excellent task breakdown mapping to acceptance criteria

**Areas for Enhancement:**
- Story is in Draft status but ready for implementation review
- Testing strategy could include automated validation scripts
- Documentation requirements could be more explicit

### Refactoring Performed

No code refactoring performed as this is a design/specification story without implementation yet.

### Compliance Check

- Coding Standards: ✓ N/A (infrastructure story)
- Project Structure: ✓ Follows Epic 0 foundation requirements exactly
- Testing Strategy: ✓ Comprehensive testing approach defined
- All ACs Met: ✓ All 5 acceptance criteria have corresponding tasks and implementation guidance

### Improvements Checklist

[All items handled in story preparation - excellent foundational work]

- [x] Complete Docker Compose service specifications provided
- [x] Database extensions and initialization requirements detailed
- [x] Environment variable structure comprehensively documented
- [x] Health check strategies for all services specified
- [x] Testing approach covering all validation scenarios defined
- [ ] Consider adding automated environment validation script
- [ ] Add explicit documentation update requirements for setup procedures
- [ ] Include troubleshooting guide as deliverable

### Security Review

**Security Assessment: PASS**

Infrastructure story with appropriate security considerations:
- Environment variables properly templated (secrets not hardcoded)
- Development credentials clearly marked as development-only
- Network isolation through Docker networking
- No security vulnerabilities identified in the design

**Recommendations:**
- Database credentials should be randomized in actual .env files
- MinIO access keys should use project-specific values for isolation

### Performance Considerations

**Performance Assessment: PASS**

Infrastructure design supports performance requirements:
- PostgreSQL 18 Beta provides enhanced JSONB performance for metadata
- Redis configured for session caching and state management
- Named volumes prevent data recreation overhead
- Health checks optimized with appropriate intervals

### Files Modified During Review

No files modified during review - story is well-prepared for implementation.

### Gate Status

Gate: READY → docs/qa/gates/0.2-docker-development-environment-setup.yml
Risk profile: docs/qa/assessments/0.2-risk-20250921.md
NFR assessment: docs/qa/assessments/0.2-nfr-20250921.md

### Recommended Status

[✓ Ready for Implementation - Excellent foundational infrastructure story]
(Story owner decides final status)

**Note:** This story demonstrates exemplary preparation with comprehensive technical context, clear requirements, and implementable guidance. The infrastructure foundation is critical for all subsequent Epic 0 stories.

