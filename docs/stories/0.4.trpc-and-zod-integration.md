# Story 0.4: tRPC and Zod Integration

## Status

Draft

## Story

**As a** developer,
**I want** tRPC configured with Zod schemas for end-to-end type safety,
**so that** API procedures have runtime validation matching TypeScript interfaces.

## Acceptance Criteria

1. tRPC server configured with router structure from architecture specification
2. Zod schemas defined for all entities: ModelSchema, FilamentSchema, etc.
3. tRPC procedures use Zod for input/output validation
4. Client-side tRPC configured with proper error handling
5. Type inference working from database to UI components

## Tasks / Subtasks

- [ ] Task 1: Install modern tRPC dependencies (AC: 1)
  - [ ] Install @trpc/server@next, @trpc/client@next, @trpc/react-query@next (2025 versions)
  - [ ] Install @tanstack/react-query@v5 with latest tRPC integration features
  - [ ] Install @trpc/next@next for enhanced Tanstack Start integration
  - [ ] Verify compatibility with existing Zod installation and latest tRPC-Zod adapters

- [ ] Task 2: Create tRPC server configuration (AC: 1, 3)
  - [ ] Create /app/api/trpc/[...trpc].ts file for Tanstack Start integration
  - [ ] Implement tRPC context with user authentication
  - [ ] Configure authentication middleware for protected procedures
  - [ ] Set up error handling for server procedures

- [ ] Task 3: Implement router structure using existing Zod schemas (AC: 2, 3)
  - [ ] Create models router with list, create, update, delete procedures
  - [ ] Create variants router with variant-specific operations
  - [ ] Create filaments router for inventory management
  - [ ] Create queue router for print job management
  - [ ] Use existing Zod schemas from /lib/schemas.ts for validation

- [ ] Task 4: Configure modern client-side tRPC with enhanced Tanstack Query integration (AC: 4, 5)
  - [ ] Create tRPC client using latest createTRPCClient() with native Tanstack Query hooks
  - [ ] Implement tRPC provider with QueryClient using new 2025 integration patterns
  - [ ] Use enhanced createTRPCReact() with automatic type inference and optimized caching
  - [ ] Configure superjson transformer for seamless Date/BigInt serialization
  - [ ] Set up tRPC-native error handling with automatic retry and exponential backoff

- [ ] Task 5: Leverage modern tRPC + Tanstack Query native hooks (AC: 5)
  - [ ] Use auto-generated tRPC hooks (api.models.list.useQuery, api.models.create.useMutation)
  - [ ] Implement tRPC-native optimistic updates with automatic rollback on error
  - [ ] Use enhanced useSuspenseQuery and useSuspenseInfiniteQuery for better UX
  - [ ] Leverage tRPC's built-in invalidation patterns with queryClient.utils
  - [ ] Ensure end-to-end type inference with latest tRPC TypeScript integration

- [ ] Task 6: Testing and validation (AC: 1-5)
  - [ ] Write unit tests for tRPC procedures
  - [ ] Test authentication middleware functionality
  - [ ] Validate Zod schema integration with runtime type checking
  - [ ] Test client-server type safety end-to-end

## Dev Notes

### Previous Story Insights

From Story 0.3 completion:
- Zod schemas already exist in `/lib/schemas.ts` matching Prisma models
- Database connection established via `/lib/db.ts` with proper Prisma client setup
- User isolation implemented via Row Level Security policies in database
- All required entities and relationships are available for tRPC integration

### Data Models

**Existing Zod Schemas** [Source: Story 0.3 completion notes]:
- UserSchema, ModelSchema, ModelVariantSchema available in `/lib/schemas.ts`
- FilamentSchema, FilamentInventorySchema, PrintJobSchema defined
- All schemas match Prisma models exactly for 1:1 type mapping
- Schemas include proper validation rules and relationships

**Database Context** [Source: Story 0.3 completion notes]:
- PostgreSQL 18 connection via Prisma client in `/lib/db.ts`
- Row Level Security ensures user data isolation automatically
- GIN indexes for full-text search performance (<2 second requirement)
- Triggers for updated_at timestamps and filament demand counting

### API Specifications

**Router Structure** [Source: docs/architecture/trpc-api-specification-with-zod.md]:
- Authentication router: `/auth` with me, updateProfile procedures
- Models router: `/models` with list, create, update, delete procedures
- Variants router: `/variants` with variant-specific operations
- Filaments router: `/filaments` for inventory management
- Queue router: `/queue` for print job management

**Authentication Middleware** [Source: docs/architecture/trpc-api-specification-with-zod.md]:
- Required authentication middleware using `requireAuth` pattern
- User context available in protected procedures
- JWT token validation integration needed

**Input/Output Validation** [Source: docs/architecture/trpc-api-specification-with-zod.md]:
- All procedures must use Zod schemas for input validation
- Output validation ensures type safety to client
- Search procedures include pagination and filtering options

### Component Specifications

**File Locations** [Source: docs/full-stack-architecture.md#frontend-component-organization]:
- tRPC server setup: `/app/api/trpc/[...trpc].ts` for Tanstack Start
- Client configuration: `/lib/api.ts` for tRPC client setup
- Hooks location: `/hooks/` directory for tRPC-based data hooks
- Types location: `/types/api.ts` for API-related type definitions

**Modern 2025 tRPC + Tanstack Query Integration** [Source: Latest tRPC documentation and 2025 patterns]:
- Use `@trpc/react-query@next` with enhanced createTRPCReact() for automatic hook generation
- Leverage `superjson` transformer for seamless Date/BigInt/undefined serialization
- Implement `useSuspenseQuery` and `useSuspenseInfiniteQuery` for better loading states
- Use tRPC-native `queryClient.utils` for invalidation patterns (utils.models.list.invalidate())
- Auto-generated typed hooks: `api.models.list.useQuery()`, `api.models.create.useMutation()`
- Enhanced optimistic updates with automatic rollback and conflict resolution
- Built-in request deduplication and intelligent caching with tRPC v11+ features

**Integration Points** [Source: docs/full-stack-architecture.md]:
- Tanstack Query v5 with latest tRPC native integration patterns
- React Aria components in `/components/ui/` for accessible interfaces
- Existing `/components/forms/` and `/components/displays/` to use auto-generated tRPC hooks

### Technical Constraints

**Performance Requirements** [Source: PRD Technical Requirements]:
- Runtime validation exactly matches TypeScript types (1:1 mapping)
- Search operations must return results within 2 seconds
- Performance optimized validation as specified in architecture

**Technology Stack** [Source: docs/full-stack-architecture.md#technology-rationale]:
- Zod + tRPC for end-to-end type safety with runtime validation
- Tanstack ecosystem for unified TypeScript experience
- 1:1 type mapping between runtime and compile-time types required

**2025 Modern Implementation Requirements**:
- Use tRPC v11+ features with enhanced Tanstack Query v5 integration
- Implement `createTRPCNext()` for optimal Tanstack Start compatibility
- Leverage auto-generated hooks instead of manual useQuery/useMutation patterns
- Use `superjson` transformer to handle complex data types (Dates, BigInts, Sets, Maps)
- Implement suspense-based data fetching with `useSuspenseQuery` for better UX
- Use tRPC's native cache invalidation with `utils.invalidate()` patterns
- Configure tRPC with streaming support for real-time updates where applicable

**Error Handling** [Source: PRD Technical Requirements]:
- Consistent error handling across all procedures
- Proper error messages for client-side display
- Development server must serve tRPC endpoints correctly

### Testing

**Testing Standards** [Source: Architecture Requirements]:
- Unit tests required for all tRPC procedures
- Integration tests for authentication middleware
- End-to-end type safety validation testing
- Client-server communication testing with mock data

**Test File Locations**:
- No specific testing architecture found in available documents
- Recommend following existing project patterns if any test files exist
- Create test files adjacent to implementation files following standard conventions

**Testing Frameworks**:
- No specific testing framework guidance found in architecture docs
- Recommend using Jest/Vitest for unit testing tRPC procedures
- Consider MSW for mocking API calls during client-side testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-23 | 1.0 | Initial story creation after ArkTypeâ†’Zod migration | Scrum Master Bob |
| 2025-09-23 | 1.1 | Enhanced with 2025 modern tRPC + Tanstack Query integration patterns | Scrum Master Bob |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA agent after implementation review*