# Story 0.7: External Service Integration Planning

## Status

Draft

## Story

**As a** developer,
**I want** external service dependencies configured and ready,
**so that** features requiring third-party services work reliably.

## Acceptance Criteria

1. Cloudflare R2 account setup with API keys and bucket configuration
2. DNS configuration planned and domain registration requirements documented
3. Resend email service configured with API keys and email templates
4. Cloudflare CDN integration configured for global asset delivery
5. Service monitoring and alerting configured
6. Frontend testing interfaces for all external services with environment-specific health indicators
7. Environment health dashboard showing staging and production service status
8. Integration testing workflow that validates frontend → backend → external service chains

## Tasks / Subtasks

- [ ] **Task 1: Cloudflare R2 Bucket Configuration and API Setup (AC: 1)**
  - [ ] Create staging R2 bucket configuration (`fm5-staging-files`) in wrangler.toml
  - [ ] Create production R2 bucket configuration (`fm5-production-files`) in wrangler.toml
  - [ ] Implement R2 storage service utilities with user isolation and file management
  - [ ] Configure bucket access patterns for secure file access with user isolation
  - [ ] Create R2 storage integration tests and validation
  - [ ] Document R2 setup and integration patterns

- [ ] **Task 2: Domain Registration and DNS Configuration Planning (AC: 2)**
  - [ ] Document domain registration requirements for production deployment
  - [ ] Plan DNS record structure for staging and production environments
  - [ ] Configure environment-specific domain settings in .env.example
  - [ ] Plan subdomain structure (app.fm5.com, api.fm5.com, staging.fm5.app, etc.)
  - [ ] Document domain configuration in external services setup guide
  - [ ] Create domain migration and setup procedures

- [ ] **Task 3: Resend Email Service Configuration (AC: 3)**
  - [ ] Create Resend email service integration with API key configuration
  - [ ] Configure email templates for user verification and system notifications
  - [ ] Implement email service with staging and production environment support
  - [ ] Create email delivery testing with development mode logging
  - [ ] Implement email template system with HTML and text versions
  - [ ] Document email service setup and template management procedures

- [ ] **Task 4: Cloudflare CDN and Global Asset Delivery (AC: 4)**
  - [ ] Configure Cloudflare CDN service with cache rules for different asset types
  - [ ] Set up image optimization and transformation utilities
  - [ ] Configure security headers and CDN performance optimization
  - [ ] Implement environment-specific CDN configuration (dev/staging/production)
  - [ ] Create CDN asset management and cache control utilities
  - [ ] Document CDN setup and cache invalidation procedures

- [ ] **Task 5: Service Monitoring and Alerting Configuration (AC: 5)**
  - [ ] Implement comprehensive health check endpoints for all external services
  - [ ] Configure health monitoring for database, email, storage, and CDN services
  - [ ] Set up service status reporting with response time monitoring
  - [ ] Create health check system with proper HTTP status codes and error handling
  - [ ] Implement service monitoring tests and validation
  - [ ] Document health check system and monitoring procedures

- [ ] **Task 6: Frontend External Service Testing Interface (AC: 6)**
  - [ ] Create R2 file upload/download testing interface with progress indicators
  - [ ] Implement Resend email testing interface (send test emails, template preview)
  - [ ] Build CDN asset delivery testing interface with performance metrics
  - [ ] Create external service configuration validation interface
  - [ ] Implement frontend integration tests for all external service workflows
  - [ ] Add user feedback and success/error states for all testing interfaces

- [ ] **Task 7: Environment Health Dashboard and Monitoring (AC: 7)**
  - [ ] Build environment health status dashboard showing staging vs production
  - [ ] Implement real-time service status indicators (R2, Resend, CDN, database)
  - [ ] Create environment-specific health check endpoints with detailed status reporting
  - [ ] Add service response time monitoring and historical uptime tracking
  - [ ] Implement alert system for service degradation or failures
  - [ ] Create environment comparison view for service configuration validation

- [ ] **Task 8: End-to-End Integration Testing Workflow (AC: 8)**
  - [ ] Create comprehensive integration tests that exercise frontend → backend → external services
  - [ ] Implement automated testing workflow for all external service endpoints
  - [ ] Build testing data setup and teardown procedures for safe testing
  - [ ] Create integration test reporting with detailed success/failure analysis
  - [ ] Implement rollback testing to validate error handling and recovery
  - [ ] Document testing procedures for ongoing external service validation

## Dev Notes

### Previous Story Insights

From Story 0.6 completion:

- **Cloudflare Workers Infrastructure**: Complete wrangler.toml configuration established with staging and production environments, providing foundation for external service integration
- **Environment Variable Management**: Comprehensive secrets configuration framework ready for external service API keys
- **Health Check Framework**: Basic health check infrastructure implemented, ready for external service monitoring
- **Production-Ready Deployment**: CI/CD pipeline established for secure deployment of external service configurations

### External Service Architecture

**Service Integration Strategy** [Source: docs/architecture/deployment-infrastructure.md]:

```
Development Environment → Staging Environment → Production Environment
       ↓                         ↓                      ↓
   MinIO (R2 Sim)         Cloudflare R2 Staging   Cloudflare R2 Production
   Local SMTP             Resend Staging          Resend Production
   Local CDN              Cloudflare CDN Test     Cloudflare CDN Live
```

**Cloudflare R2 Configuration** [Source: docs/architecture/deployment-infrastructure.md]:

- **Purpose**: File storage for 3D models, sliced files, and generated content
- **Free Tier**: 10GB storage, 1M Class A operations/month
- **Integration**: Native Cloudflare Workers integration via R2Bucket binding
- **Buckets**: Separate staging (`fm5-staging-files`) and production (`fm5-production-files`) buckets for isolation
- **Security**: User-specific file paths (/users/{userId}/models/{modelId}/) with signed URLs

**Resend Email Service Configuration** [Source: docs/architecture/deployment-infrastructure.md]:

- **Purpose**: Transactional email delivery (user verification, notifications)
- **Free Tier**: 3k emails/month, 100 emails/day
- **Integration**: HTTP API compatible with Cloudflare Workers
- **Features**: Email templates, bounce/complaint handling, analytics
- **Template Structure**: Welcome emails, verification emails, system notifications

**Cloudflare CDN Integration** [Source: docs/architecture/deployment-infrastructure.md]:

- **Purpose**: Global asset delivery optimization
- **Features**: Image optimization, compression, caching rules
- **Configuration**: Asset handling served via Cloudflare CDN for static assets
- **Performance**: Global edge network for sub-100ms response times

### API Integration Patterns

**R2 Storage Integration Pattern** [Source: docs/architecture/deployment-infrastructure.md]:

```typescript
// File storage binding available in Workers
interface Env {
  FILE_STORAGE: R2Bucket
}

export async function uploadFile(env: Env, key: string, file: File) {
  await env.FILE_STORAGE.put(key, file.stream(), {
    httpMetadata: { contentType: file.type },
  })
}
```

**Resend Email Integration Pattern** [Source: docs/architecture/deployment-infrastructure.md]:

```typescript
// lib/email.ts
import { Resend } from 'resend'

const resend = new Resend(process.env.RESEND_API_KEY)

export async function sendVerificationEmail(
  email: string,
  token: string,
): Promise<void> {
  await resend.emails.send({
    from: 'noreply@fm5.app',
    to: email,
    subject: 'Verify your FM5 account',
    html: `<p>Click <a href="https://app.fm5.com/verify?token=${token}">here</a> to verify your account.</p>`,
  })
}
```

### Environment Variable Configuration

**Required Environment Variables** [Source: docs/architecture/deployment-infrastructure.md]:

**Staging Environment:**

```bash
# R2 Configuration
R2_ACCOUNT_ID=<cloudflare-account-id>
R2_ACCESS_KEY_ID=<staging-r2-access-key>
R2_SECRET_ACCESS_KEY=<staging-r2-secret-key>

# Email Configuration
RESEND_API_KEY=<staging-resend-api-key>

# Domain Configuration
APP_DOMAIN=staging.fm5.app
API_DOMAIN=api-staging.fm5.app
```

**Production Environment:**

```bash
# R2 Configuration
R2_ACCOUNT_ID=<cloudflare-account-id>
R2_ACCESS_KEY_ID=<production-r2-access-key>
R2_SECRET_ACCESS_KEY=<production-r2-secret-key>

# Email Configuration
RESEND_API_KEY=<production-resend-api-key>

# Domain Configuration
APP_DOMAIN=app.fm5.com
API_DOMAIN=api.fm5.com
```

### Security and Access Control

**File Security Configuration** [Source: docs/architecture/deployment-infrastructure.md]:

- **Upload Validation**: File type and size restrictions
- **Access Control**: Signed URLs for secure file access
- **User Isolation**: File paths include user ID for isolation (/users/{userId}/)
- **Bucket Policies**: Configured for secure file access with staging/production separation

**Email Security Configuration**:

- **Domain Verification**: SPF, DKIM, DMARC records for sending domain
- **API Key Security**: Separate keys for staging and production environments
- **Template Security**: HTML template sanitization and validation

### Monitoring and Alerting Strategy

**Service Monitoring Configuration** [Source: docs/architecture/deployment-infrastructure.md]:

- **Cloudflare Analytics**: Request metrics, performance monitoring
- **Resend Analytics**: Email delivery and engagement metrics
- **Cost Monitoring**: Usage tracking for Cloudflare services and Resend
- **Health Checks**: Automated service availability monitoring

**Alerting Rules**:

- **Error Rate Alerts**: >5% error rate triggers notification
- **Performance Alerts**: >1000ms P95 response time alerts
- **Email Delivery**: Bounce rate or delivery failure alerts
- **Cost Alerts**: Usage threshold notifications

### File Locations and Project Structure

**New Files to Create** [Source: existing project structure]:

- `lib/r2-storage.ts`: R2 bucket integration utilities
- `lib/email-service.ts`: Resend email service integration
- `lib/cdn-config.ts`: CDN configuration utilities
- `scripts/setup-external-services.sh`: External service setup automation
- `docs/external-services-setup.md`: Service configuration documentation

**Files to Modify** [Source: existing project structure]:

- `wrangler.toml`: Add R2 bucket bindings for staging and production
- `.env.example`: Add external service environment variables template
- `lib/auth.ts`: Integrate email verification with Resend
- `src/routes/health.tsx`: Add external service health checks

### Cost and Usage Management

**Service Cost Structure** [Source: docs/architecture/deployment-infrastructure.md]:

- **R2 Storage**: $0.015/GB/month, free tier: 10GB
- **Resend**: $20/month for 100k emails (after free tier)
- **Cloudflare Workers**: $5/10M requests (very cost effective)
- **Usage Tracking**: Monthly cost reports via Cloudflare dashboard

**Scaling Considerations**:

- **Storage**: R2 scales automatically, pay per GB stored
- **Email**: Resend scales based on volume, predictable pricing
- **CDN**: Included with Cloudflare Workers, global edge performance

## Testing

### Testing Standards

**Test File Locations** [Source: existing patterns]:

- **Service Integration Tests**: `src/__tests__/external-services-*.test.ts`
- **R2 Storage Tests**: `src/__tests__/r2-storage.test.ts`
- **Email Service Tests**: `src/__tests__/email-service.test.ts`
- **Health Check Tests**: `src/__tests__/health-check-external.test.ts`

**Testing Framework** [Source: existing setup]:

- **Test Runner**: Jest/Vitest with existing configuration
- **Environment**: Test against staging services with mock fallbacks
- **Coverage**: Service connectivity, configuration validation, error handling

**Specific Testing Requirements:**

- **R2 Integration Testing**: Bucket connectivity, upload/download functionality, signed URL generation
- **Email Service Testing**: Template rendering, delivery confirmation, bounce handling
- **CDN Testing**: Asset delivery performance, cache behavior validation
- **Health Check Testing**: Service availability monitoring, alerting functionality
- **Configuration Testing**: Environment variable validation, service initialization

## Change Log

| Date       | Version | Description                                                          | Author           |
| ---------- | ------- | -------------------------------------------------------------------- | ---------------- |
| 2025-09-27 | 1.0     | Initial comprehensive story creation                                 | Scrum Master Bob |
| 2025-09-27 | 1.1     | Added frontend testing integration and environment health monitoring | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

[To be filled by development agent]

### Debug Log References

[To be filled by development agent]

### Completion Notes

[To be filled by development agent]

### File List

[To be filled by development agent]

### Completion Notes

### Debug Log References

### Change Log

## QA Results

[To be filled by QA agent]
