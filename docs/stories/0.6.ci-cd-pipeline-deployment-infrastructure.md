# Story 0.6: CI/CD Pipeline and Deployment Infrastructure

## Status

Draft

## Story

**As a** developer,
**I want** automated deployment pipeline and production infrastructure configured with Cloudflare Workers,
**so that** code can be deployed safely and consistently to staging and production environments with global performance.

## Acceptance Criteria

1. **Cloudflare Workers Deployment**: Staging and production Workers configured with automated deployment
2. **Xata Database Integration**: Production PostgreSQL databases configured for staging and production environments
3. **GitHub Actions CI/CD**: Automated testing pipeline with staging deployment and manual production promotion
4. **Environment Configuration**: Complete environment variable management and secrets configuration
5. **Wrangler Infrastructure**: Infrastructure as Code using Wrangler CLI for deployment lifecycle management
6. **Monitoring and Health Checks**: Basic monitoring, logging, and health check endpoints configured
7. **Rollback Procedures**: Deployment rollback and recovery procedures documented and tested

## Tasks / Subtasks

- [ ] **Task 1: Configure Cloudflare Workers Infrastructure (AC: 1)**
  - [ ] Create Cloudflare account and configure Workers project
  - [ ] Set up staging Worker environment (`fm5-staging`)
  - [ ] Set up production Worker environment (`fm5-production`)
  - [ ] Configure custom domains for staging and production
  - [ ] Test basic Worker deployment with hello world endpoint

- [ ] **Task 2: Configure Xata Database Production Setup (AC: 2)**
  - [ ] Create Xata account and staging database (`fm5-staging`)
  - [ ] Create production database (`fm5-production`)
  - [ ] Configure database connection URLs and API keys
  - [ ] Test database connectivity from Cloudflare Workers
  - [ ] Migrate existing Prisma schema to Xata databases

- [ ] **Task 3: Implement GitHub Actions CI/CD Pipeline (AC: 3)**
  - [ ] Create `.github/workflows/deploy.yml` workflow file
  - [ ] Configure automated testing stage (ESLint, tests, build)
  - [ ] Implement staging deployment automation on main branch
  - [ ] Configure manual production deployment with approval
  - [ ] Set up GitHub secrets for Cloudflare API tokens and environment variables

- [ ] **Task 4: Configure Environment Variables and Secrets (AC: 4)**
  - [ ] Set up Wrangler secrets for staging environment
  - [ ] Set up Wrangler secrets for production environment
  - [ ] Configure database URLs, JWT secrets, and API keys
  - [ ] Test environment variable access in Workers
  - [ ] Document environment variable management procedures

- [ ] **Task 5: Implement Wrangler Infrastructure Configuration (AC: 5)**
  - [ ] Create `wrangler.toml` configuration for staging
  - [ ] Create `wrangler.toml` configuration for production
  - [ ] Configure R2 bucket bindings for file storage
  - [ ] Set up environment-specific configuration
  - [ ] Test Wrangler deployment commands locally

- [ ] **Task 6: Set Up Monitoring and Health Checks (AC: 6)**
  - [ ] Implement `/health` endpoint with database and R2 connectivity checks
  - [ ] Configure Cloudflare Analytics for request monitoring
  - [ ] Set up basic error logging and reporting
  - [ ] Create monitoring dashboard for key metrics
  - [ ] Test health check endpoints in staging and production

- [ ] **Task 7: Implement Rollback and Recovery Procedures (AC: 7)**
  - [ ] Document Wrangler rollback commands and procedures
  - [ ] Test deployment rollback in staging environment
  - [ ] Create recovery runbook for common deployment issues
  - [ ] Implement version tagging for production deployments
  - [ ] Test complete deployment and rollback cycle

- [ ] **Task 8: Integration Testing and Validation (AC: 1-7)**
  - [ ] Deploy current application to staging Worker
  - [ ] Validate BetterAuth integration with Xata in staging
  - [ ] Test R2 file storage integration with Workers
  - [ ] Verify environment promotion (staging → production)
  - [ ] Run end-to-end tests against staging deployment

## Dev Notes

### Previous Story Insights

From Story 0.5 completion:
- **BetterAuth Production Ready**: Authentication system successfully implemented with JWT tokens, ready for Xata PostgreSQL integration
- **Database Schema Established**: Prisma schema includes all required tables (users, sessions, accounts) with proper relationships for BetterAuth
- **tRPC Infrastructure**: Complete API structure with authentication middleware, ready for Cloudflare Workers deployment
- **Docker Development**: Local development environment fully functional, provides baseline for production parity

### Architecture Decisions

**Deployment Architecture** [Source: docs/architecture/deployment-infrastructure.md]:

```
Development (Docker) → Staging (Cloudflare Worker) → Production (Cloudflare Worker)
                    ↓                               ↓
              Local PostgreSQL              Xata PostgreSQL (staging & production)
                    ↓                               ↓
                MinIO                     Cloudflare R2 (staging & production buckets)
```

**Technology Stack** [Source: docs/architecture/deployment-infrastructure.md]:
- **Deployment Platform**: Cloudflare Workers (serverless edge deployment)
- **Database**: Xata PostgreSQL with HTTP API (no connection pooling needed)
- **File Storage**: Cloudflare R2 with native Workers integration
- **Email Service**: Resend HTTP API integration
- **CI/CD**: GitHub Actions with Wrangler CLI deployment
- **Monitoring**: Cloudflare Analytics with custom health checks

### Infrastructure Components

**Cloudflare Workers Configuration** [Source: docs/architecture/deployment-infrastructure.md]:

**Staging Worker (`fm5-staging`):**
```toml
# wrangler.toml
name = "fm5-staging"
main = ".output/server/index.mjs"
compatibility_date = "2024-09-01"
compatibility_flags = ["nodejs_compat"]

[env.staging]
vars = { NODE_ENV = "staging", APP_ENV = "staging" }

[[env.staging.r2_buckets]]
binding = "FILE_STORAGE"
bucket_name = "fm5-staging-files"
```

**Production Worker (`fm5-production`):**
```toml
# wrangler.toml
name = "fm5-production"
main = ".output/server/index.mjs"
compatibility_date = "2024-09-01"
compatibility_flags = ["nodejs_compat"]

[env.production]
vars = { NODE_ENV = "production", APP_ENV = "production" }

[[env.production.r2_buckets]]
binding = "FILE_STORAGE"
bucket_name = "fm5-production-files"
```

### Database Integration

**Xata Configuration** [Source: docs/architecture/deployment-infrastructure.md]:

**Connection Strategy:**
- **Development**: Prisma → Local PostgreSQL (existing Docker setup)
- **Staging**: Prisma → Xata HTTP API (`fm5-staging` database)
- **Production**: Prisma → Xata HTTP API (`fm5-production` database)

**Environment Variables Required:**
```bash
# Staging
XATA_API_KEY=<staging-xata-api-key>
XATA_DATABASE_URL=<staging-xata-database-url>

# Production
XATA_API_KEY=<production-xata-api-key>
XATA_DATABASE_URL=<production-xata-database-url>
```

**Migration Strategy:**
1. Export existing Prisma schema
2. Import schema to Xata staging database
3. Test application against staging database
4. Import schema to Xata production database
5. Configure environment variables for both environments

### CI/CD Pipeline Architecture

**GitHub Actions Workflow** [Source: docs/architecture/deployment-infrastructure.md]:

**Pipeline Stages:**
1. **Code Quality**: ESLint, Prettier, TypeScript checking
2. **Testing**: Unit tests, integration tests
3. **Build**: Tanstack Start production build with Nitro output
4. **Security**: Dependency vulnerability scanning
5. **Deploy Staging**: Automatic Wrangler deployment to staging
6. **Deploy Production**: Manual approval and deployment to production

**Workflow File Structure:**
```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]        # Auto-deploy to staging
  workflow_dispatch:        # Manual production deployment

jobs:
  test-and-build:          # Quality gates
  deploy-staging:          # Automatic staging deployment
  deploy-production:       # Manual production deployment
```

### Environment Variable Management

**Required Secrets** [Source: docs/architecture/deployment-infrastructure.md]:

**GitHub Repository Secrets:**
- `CLOUDFLARE_API_TOKEN`: Cloudflare API token for Wrangler deployment
- `XATA_STAGING_API_KEY`: Xata API key for staging database
- `XATA_PRODUCTION_API_KEY`: Xata API key for production database

**Wrangler Secrets (per environment):**
```bash
# Authentication
JWT_SECRET=<environment-specific-jwt-secret>
BETTER_AUTH_SECRET=<environment-specific-auth-secret>

# Database
XATA_API_KEY=<environment-xata-api-key>
XATA_DATABASE_URL=<environment-xata-database-url>

# Email Service
RESEND_API_KEY=<environment-resend-api-key>

# File Storage (if needed)
R2_ACCESS_KEY_ID=<environment-r2-access-key>
R2_SECRET_ACCESS_KEY=<environment-r2-secret-key>
```

### Integration Points

**BetterAuth Integration** [Source: docs/architecture/deployment-infrastructure.md]:

```typescript
// lib/auth.ts - Production configuration
export const auth = betterAuth({
  database: {
    provider: "postgres",
    url: process.env.XATA_DATABASE_URL, // Xata HTTP API URL
  },
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 days
    updateAge: 60 * 60 * 24,     // 24 hours
  },
  jwt: {
    issuer: "fm5-app",
    audience: ["fm5-web"],
  },
  plugins: [
    nodejs(), // Required for Cloudflare Workers
  ],
})
```

**R2 File Storage Integration:**
```typescript
// File storage binding available in Workers
interface Env {
  FILE_STORAGE: R2Bucket
}

export async function uploadFile(env: Env, key: string, file: File) {
  await env.FILE_STORAGE.put(key, file.stream(), {
    httpMetadata: { contentType: file.type },
  })
}
```

### File Locations and Project Structure

**New Files to Create** [Source: project structure]:
- `.github/workflows/deploy.yml`: CI/CD pipeline configuration
- `wrangler.toml`: Cloudflare Workers configuration (staging/production)
- `src/routes/health.tsx`: Health check endpoint
- `scripts/deploy.sh`: Deployment helper scripts (optional)

**Files to Modify** [Source: existing project structure]:
- `lib/auth.ts`: Add production Xata configuration
- `lib/trpc.ts`: Ensure Cloudflare Workers compatibility
- `package.json`: Add Wrangler CLI dependency
- `.env.example`: Add production environment variables template

### Monitoring and Health Checks

**Health Check Endpoint** [Source: docs/architecture/deployment-infrastructure.md]:

```typescript
// /health endpoint implementation
export async function healthCheck(): Promise<Response> {
  try {
    // Check Xata database connectivity
    const dbCheck = await xata.db.users.getFirst()

    // Check R2 storage connectivity
    const r2Check = await env.FILE_STORAGE.head('health-check')

    return new Response(JSON.stringify({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      services: {
        database: 'ok',
        storage: 'ok'
      }
    }), {
      headers: { 'Content-Type': 'application/json' }
    })
  } catch (error) {
    return new Response(JSON.stringify({
      status: 'unhealthy',
      error: error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    })
  }
}
```

**Monitoring Configuration:**
- **Cloudflare Analytics**: Request metrics, error rates, performance
- **Custom Metrics**: Health check success rates, database response times
- **Log Aggregation**: Wrangler tail for real-time debugging

### Testing Requirements

**Testing Strategy** [Source: docs/architecture/deployment-infrastructure.md]:

**Deployment Testing:**
- **Unit Tests**: All existing tests must pass in CI pipeline
- **Integration Tests**: Database connectivity tests with Xata
- **Health Check Tests**: Automated testing of health endpoints
- **Rollback Tests**: Deployment rollback procedures validation

**Environment Testing:**
- **Staging Validation**: Full application functionality in staging
- **Production Smoke Tests**: Basic functionality after production deployment
- **Cross-Environment**: Ensure parity between staging and production

### Rollback and Recovery Procedures

**Rollback Strategy** [Source: docs/architecture/deployment-infrastructure.md]:

**Wrangler Commands:**
```bash
# List deployments
wrangler deployments list --name fm5-production

# Rollback to previous version
wrangler rollback --name fm5-production [DEPLOYMENT_ID]

# Emergency rollback
wrangler rollback --name fm5-production --message "Emergency rollback"
```

**Recovery Procedures:**
1. **Immediate Rollback**: Use Wrangler rollback to previous working version
2. **Database Issues**: Verify Xata connectivity and API keys
3. **R2 Issues**: Check bucket permissions and access keys
4. **Environment Variables**: Verify all secrets are properly configured
5. **DNS Issues**: Check custom domain configuration in Cloudflare

## Testing

### Testing Standards

**Test File Locations** [Source: existing patterns]:
- **Deployment Tests**: `src/__tests__/deployment-*.test.ts`
- **Health Check Tests**: `src/__tests__/health-check.test.ts`
- **Integration Tests**: `src/__tests__/integration-*.test.ts`

**Testing Framework** [Source: existing setup]:
- **Test Runner**: Jest/Vitest with existing configuration
- **Environment**: Test deployments against staging Worker
- **Coverage**: Health endpoints, deployment procedures, rollback testing

**Specific Testing Requirements:**
- **Pipeline Testing**: Validate CI/CD workflow stages
- **Environment Testing**: Staging and production deployment validation
- **Health Check Testing**: Database and R2 connectivity validation
- **Rollback Testing**: Deployment rollback and recovery procedures
- **Integration Testing**: BetterAuth, tRPC, R2 integration with Workers

## Change Log

| Date       | Version | Description                                   | Author              |
| ---------- | ------- | --------------------------------------------- | ------------------- |
| 2025-09-24 | 1.0     | Initial comprehensive story creation          | Product Owner Sarah |

## Dev Agent Record

### Agent Model Used

_To be populated during implementation_

### Debug Log References

_To be populated during implementation_

### Completion Notes

_To be populated during implementation_

### File List

_To be populated during implementation_

## QA Results

_To be populated during QA review_