# Test Design: Story 0.2 - Docker Development Environment Setup

**Date:** 2025-09-21
**Designer:** Quinn (Test Architect)
**Story:** 0.2 - Docker Development Environment Setup

## Test Strategy Overview

- **Total test scenarios:** 18
- **Unit tests:** 3 (17%)
- **Integration tests:** 10 (56%)
- **E2E tests:** 5 (27%)
- **Priority distribution:** P0: 8, P1: 7, P2: 3

## Test Scenarios by Acceptance Criteria

### AC1: Docker Compose configuration creates PostgreSQL 18 Beta container with extensions

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 0.2-UNIT-001 | Unit        | P1       | Validate docker-compose.yml syntax     | Configuration validation logic       |
| 0.2-INT-001  | Integration | P0       | PostgreSQL container starts successfully | Critical service dependency         |
| 0.2-INT-002  | Integration | P0       | Database extensions install correctly    | Essential for future stories        |
| 0.2-E2E-001  | E2E         | P1       | Complete PostgreSQL setup workflow      | End-to-end service validation       |

### AC2: Redis 7 Alpine container configured for session/cache storage during development

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                    |
| ------------ | ----------- | -------- | ------------------------------------ | -------------------------------- |
| 0.2-INT-003  | Integration | P0       | Redis container starts successfully  | Critical for session management  |
| 0.2-INT-004  | Integration | P1       | Redis persistence (AOF) configuration | Data retention across restarts   |
| 0.2-E2E-002  | E2E         | P1       | Redis connectivity from application   | Service integration validation   |

### AC3: MinIO container configured for local Cloudflare R2 simulation

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                     |
| ------------ | ----------- | -------- | ------------------------------------ | --------------------------------- |
| 0.2-INT-005  | Integration | P0       | MinIO container starts successfully  | Critical for file storage         |
| 0.2-INT-006  | Integration | P1       | MinIO S3 API compatibility          | Cloudflare R2 simulation required |
| 0.2-INT-007  | Integration | P2       | MinIO bucket creation                | Storage organization              |
| 0.2-E2E-003  | E2E         | P1       | MinIO file upload/download workflow  | Complete storage functionality    |

### AC4: Database initialization script creates proper extensions (uuid-ossp, pg_stat_statements)

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 0.2-UNIT-002 | Unit        | P1       | Validate init-db.sql syntax           | SQL script validation               |
| 0.2-INT-008  | Integration | P0       | uuid-ossp extension installation       | Required for entity primary keys    |
| 0.2-INT-009  | Integration | P0       | pg_stat_statements extension install   | Performance monitoring foundation   |
| 0.2-E2E-004  | E2E         | P1       | Database initialization workflow       | Complete setup validation          |

### AC5: All services accessible on specified ports with health checks

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                      |
| ------------ | ----------- | -------- | ------------------------------------ | ---------------------------------- |
| 0.2-UNIT-003 | Unit        | P2       | Health check configuration validity  | Configuration validation           |
| 0.2-INT-010  | Integration | P0       | All service health checks pass       | Service availability critical      |
| 0.2-INT-011  | Integration | P1       | Service port accessibility          | External connectivity validation   |
| 0.2-INT-012  | Integration | P1       | Inter-service network communication  | Container networking verification  |
| 0.2-E2E-005  | E2E         | P0       | Complete environment startup         | Full workflow integration         |

## Additional Infrastructure Testing

### Environment and Configuration

| ID           | Level       | Priority | Test                                 | Justification                      |
| ------------ | ----------- | -------- | ------------------------------------ | ---------------------------------- |
| 0.2-INT-013  | Integration | P1       | Environment variable loading        | Configuration management critical  |
| 0.2-INT-014  | Integration | P2       | Volume persistence across restarts  | Data retention validation         |
| 0.2-INT-015  | Integration | P2       | Service dependency ordering         | Startup sequence verification     |

## Risk Coverage

This test design addresses identified risks:

- **PostgreSQL 18 Beta stability** → Tests 0.2-INT-001, 0.2-INT-002, 0.2-E2E-001
- **Service startup dependencies** → Tests 0.2-INT-015, 0.2-E2E-005
- **Service configuration errors** → Tests 0.2-UNIT-001, 0.2-UNIT-002, 0.2-UNIT-003
- **Volume persistence issues** → Test 0.2-INT-014
- **Environment variable confusion** → Test 0.2-INT-013

## Detailed Test Specifications

### P0 Critical Tests

#### 0.2-INT-001: PostgreSQL Container Startup
```yaml
test_type: Integration
priority: P0
description: Verify PostgreSQL 18 Beta container starts and accepts connections
preconditions: Docker Compose configuration present
steps:
  - Execute docker-compose up postgres
  - Wait for health check to pass
  - Verify connection on port 5432
expected_result: PostgreSQL container running and accepting connections
error_scenarios:
  - Container fails to start
  - Health check timeout
  - Port binding conflicts
```

#### 0.2-INT-008: UUID Extension Installation
```yaml
test_type: Integration
priority: P0
description: Verify uuid-ossp extension is properly installed
preconditions: PostgreSQL container running
steps:
  - Connect to database
  - Query pg_extension for uuid-ossp
  - Test UUID generation function
expected_result: Extension installed and functional
error_scenarios:
  - Extension not found
  - UUID generation fails
  - Permission errors
```

#### 0.2-E2E-005: Complete Environment Startup
```yaml
test_type: End-to-End
priority: P0
description: Verify entire development environment starts successfully
preconditions: Clean Docker environment
steps:
  - Execute docker-compose up
  - Wait for all health checks
  - Verify all service connectivity
  - Test basic operations on each service
expected_result: All services running and accessible
error_scenarios:
  - Any service fails to start
  - Health check failures
  - Network connectivity issues
```

### P1 High Priority Tests

#### 0.2-INT-004: Redis Persistence Configuration
```yaml
test_type: Integration
priority: P1
description: Verify Redis append-only file (AOF) persistence
preconditions: Redis container running
steps:
  - Set test data in Redis
  - Restart Redis container
  - Verify data persistence
expected_result: Data retained across restart
error_scenarios:
  - Data loss on restart
  - AOF configuration errors
```

#### 0.2-INT-006: MinIO S3 API Compatibility
```yaml
test_type: Integration
priority: P1
description: Verify MinIO provides S3-compatible API
preconditions: MinIO container running
steps:
  - Test S3 list buckets operation
  - Test object upload
  - Test object download
  - Verify API responses match S3 format
expected_result: S3 API compatibility confirmed
error_scenarios:
  - API incompatibility
  - Authentication failures
  - Object operations fail
```

## Recommended Execution Order

### Phase 1: Critical Infrastructure (P0)
1. 0.2-INT-001 (PostgreSQL startup)
2. 0.2-INT-003 (Redis startup)
3. 0.2-INT-005 (MinIO startup)
4. 0.2-INT-008 (uuid-ossp extension)
5. 0.2-INT-009 (pg_stat_statements extension)
6. 0.2-INT-010 (Health checks)
7. 0.2-E2E-005 (Complete environment)

### Phase 2: Core Functionality (P1)
8. 0.2-UNIT-001 (Docker Compose validation)
9. 0.2-UNIT-002 (SQL script validation)
10. 0.2-INT-004 (Redis persistence)
11. 0.2-INT-006 (MinIO S3 compatibility)
12. 0.2-INT-011 (Port accessibility)
13. 0.2-INT-012 (Inter-service networking)
14. 0.2-INT-013 (Environment variables)

### Phase 3: Additional Coverage (P2)
15. 0.2-UNIT-003 (Health check config)
16. 0.2-INT-007 (MinIO bucket creation)
17. 0.2-INT-014 (Volume persistence)
18. 0.2-INT-015 (Service dependencies)

## Test Environment Requirements

### Local Development
- Docker Desktop or Docker Engine
- Docker Compose 2.0+
- Available ports: 5432, 6379, 9000, 9001
- Minimum 4GB RAM for containers

### CI/CD Pipeline
- Docker-in-Docker capability
- Container orchestration support
- Network isolation for parallel execution
- Artifact storage for test results

## Test Data Strategy

### PostgreSQL
- Test database: `printmgmt_test`
- Test user: `test_user` with limited permissions
- Sample data: Minimal test fixtures

### Redis
- Test keys with `test:` prefix
- TTL-based cleanup strategy
- Isolated test databases (DB 1-15)

### MinIO
- Test bucket: `printmgmt-test`
- Test objects with UUID naming
- Cleanup policy for test artifacts

## Success Criteria

### Definition of Done for Testing
- [ ] All P0 tests passing (100% success rate)
- [ ] P1 tests >95% success rate
- [ ] All services startup within 60 seconds
- [ ] Health checks stable for >5 minutes
- [ ] No resource leaks after teardown
- [ ] Documentation updated with test procedures

### Performance Benchmarks
- PostgreSQL startup: <30 seconds
- Redis startup: <10 seconds
- MinIO startup: <20 seconds
- Total environment startup: <60 seconds
- Health check response: <5 seconds

## Maintenance Considerations

### Test Stability
- Avoid timing-dependent assertions
- Use polling with timeouts for async operations
- Implement proper cleanup procedures
- Handle resource contention gracefully

### Monitoring and Alerts
- Track test execution time trends
- Monitor container resource usage
- Alert on consistent test failures
- Log detailed failure information

This comprehensive test design ensures robust validation of the Docker development environment while maintaining efficient test execution and clear failure diagnosis.